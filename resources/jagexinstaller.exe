#!/bin/bash 
set -e
set -x
wine --version
env

#Compatibility between steam and lutris runtimes
if [[ -v WINEBIN ]]; then
    echo "WINEBIN is set"
else
    echo "Setting WINEBIN to be the wine executable..."
    export WINEBIN=$(realpath "$(which wine)")
fi

if [[ -v WINEPREFIX ]]; then
    echo "WINEPREFIX is set"
else
    echo "Setting WINEPREFX to be the game directory..."
    export WINEPREFIX="$GAMEDIR"
fi

exec 3>&1 4>&2
trap 'exec 2>&4 1>&3' 0 1 2 3
exec 1>"$WINEPREFIX"log.out 2>&1



"$WINEBIN" --version

jagex_launcher_installer_url="https://cdn.jagex.com/Jagex%20Launcher%20Installer.exe"
runelite_url="https://github.com/runelite/launcher/releases/download/2.6.4/RuneLite.AppImage"
runelite_launcher_url="https://raw.githubusercontent.com/TormStorm/jagex-launcher-linux/main/resources/runelite.sh"
runescape_launcher_url="https://raw.githubusercontent.com/TormStorm/jagex-launcher-linux/main/resources/runescape.sh"
steamdeck_config_url="https://raw.githubusercontent.com/TormStorm/jagex-launcher-linux/main/resources/steamdeck-config.properties"

runelite_location="$WINEPREFIX""drive_c/Program Files (x86)/Jagex Launcher/Games/RuneLite"
runescape_location="$WINEPREFIX""drive_c/Program Files (x86)/Jagex Launcher/Games/RuneScape"

curl -L "$jagex_launcher_installer_url" > "$WINEPREFIX"jagexlauncherinstaller.exe
WINEDLLOVERRIDES="jscript.dll=n" "$WINEBIN" "$WINEPREFIX"jagexlauncherinstaller.exe &
installer_process="$!"

above_200=0

echo "Beginning installation..."

while true 
do
    echo "Checking directory size..."
    # Grab directory size for jagex launcher install directory. This is how we know when to kill the installer window.
    dir_size=$(((du -sh "$WINEPREFIX""drive_c/Program Files (x86)/Jagex Launcher" 2> /dev/null) || echo '0G') | awk '{ print $1 }')
    # Remove the last character from the dir_size so the units don't show
    dir_size=$(echo "$dir_size" | sed 's/.$//')

    # If the directory size is above 200M, then add one to the above_200 variable
    if (( $dir_size > 200 )); then
        above_200=$((above_200+1))
    fi

    # If the directory has been above 200M for 20 seconds, then the installer is likely done and we can kill the window.
    if (( $above_200 > 1 )); then
        kill "$installer_process"
        break # Exit the while loop
    fi
    sleep 10
done;

echo "Starting symlink"

mkdir -p "$runelite_location"
mkdir -p "$runescape_location"

curl -L "$runelite_url" > "$runelite_location/RuneLite.AppImage"
chmod +x "$runelite_location/RuneLite.AppImage"

curl -L "$runelite_launcher_url" > "$runelite_location/runelite.sh"
chmod +x "$runelite_location/runelite.sh"

curl -L "$runescape_launcher_url" > "$runescape_location/runescape.sh"
chmod +x "$runescape_location/runescape.sh"

curl -L "$steamdeck_config_url" > "$WINEPREFIX""steamdeck-config.properties"
chmod +x "$runescape_location/runescape.sh"

file_path="$WINEPREFIX"/"regimport.reg"

cat >"$file_path" <<EOL
Windows Registry Editor Version 5.00
[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Uninstall\RuneScape Launcher_is1]
"InstallLocation"="C:\\\Program Files (x86)\\\Jagex Launcher\\\Games\\\RuneScape"

[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Uninstall\RuneLite Launcher_is1]
"InstallLocation"="C:\\\Program Files (x86)\\\Jagex Launcher\\\Games\\\RuneLite"
... 
EOL

"$WINEBIN" regedit.exe "$file_path"

ln -s "$runelite_location/runelite.sh" "$runelite_location/RuneLite.exe"
ln -s "$runescape_location/runescape.sh" "$runescape_location/RuneScape.exe"
